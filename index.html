<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Mesopotamia Cell Game (Multiplayer + Quiz)</title>
    <style>
        /* ===================================================================
           GLOBAL STYLES
        =================================================================== */
        body {
            margin: 0;
            display: flex;
            flex-direction: row;
            font-family: Arial, sans-serif;
            background: radial-gradient(circle at top, #1e293b, #020617);
            color: #e5e7eb;
            height: 100vh;
            overflow: hidden;
        }

        #gameContainer {
            position: relative;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        #gameCanvas {
            flex: 1;
            background: radial-gradient(circle, #0f172a 0%, #020617 100%);
            display: block;
        }

        #uiContainer {
            position: absolute;
            top: 10px;
            left: 10px;
            right: 10px;
            z-index: 10;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            pointer-events: none;
        }

        .ui-panel {
            background: rgba(15, 23, 42, 0.9);
            border-radius: 16px;
            padding: 10px 14px;
            margin-bottom: 10px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.6);
            pointer-events: auto;
        }

        #topLeftPanel {
            min-width: 260px;
        }

        #topRightPanel {
            min-width: 260px;
            text-align: right;
        }

        #bottomPanel {
            position: absolute;
            bottom: 10px;
            left: 10px;
            right: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            pointer-events: none;
        }

        #controlsPanel {
            pointer-events: auto;
            background: rgba(15, 23, 42, 0.9);
            border-radius: 16px;
            padding: 10px 14px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.6);
        }

        #messageLog {
            pointer-events: auto;
            background: rgba(15, 23, 42, 0.9);
            border-radius: 16px;
            padding: 10px 14px;
            max-width: 420px;
            max-height: 120px;
            overflow-y: auto;
            font-size: 13px;
        }

        #minimapContainer {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: rgba(15, 23, 42, 0.9);
            border-radius: 16px;
            padding: 8px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.6);
            pointer-events: auto;
        }

        #minimap {
            border-radius: 8px;
            background: #020617;
        }

        #leaderboard {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 260px;
            background: rgba(15, 23, 42, 0.95);
            border-radius: 16px;
            padding: 12px 16px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.8);
            pointer-events: auto;
        }

        #leaderboard h3 {
            margin: 0 0 8px 0;
            font-size: 16px;
        }

        #leaderboardList {
            font-size: 13px;
            max-height: 260px;
            overflow-y: auto;
        }

        #leaderboardList .leaderboard-entry {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            border-bottom: 1px solid rgba(148, 163, 184, 0.2);
        }

        #leaderboardList .leaderboard-entry span.name {
            max-width: 120px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        #leaderboardList .leaderboard-entry span.stats {
            text-align: right;
            font-family: monospace;
        }

        #startScreen {
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at top, rgba(15, 23, 42, 0.98), rgba(2, 6, 23, 0.98));
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
            color: #e5e7eb;
        }

        #startScreen h1 {
            font-size: 32px;
            margin-bottom: 10px;
        }

        #startScreen h2 {
            font-size: 20px;
            margin-bottom: 20px;
            color: #93c5fd;
        }

        #startScreen label {
            display: block;
            margin-bottom: 6px;
            font-size: 14px;
        }

        #startScreen input, #startScreen select {
            width: 260px;
            padding: 8px;
            margin-bottom: 12px;
            border-radius: 8px;
            border: 1px solid #4b5563;
            background: #020617;
            color: #e5e7eb;
        }

        #startButton {
            width: 260px;
            padding: 10px;
            border-radius: 9999px;
            border: none;
            background: linear-gradient(90deg, #f97316, #facc15);
            color: #111827;
            font-weight: bold;
            font-size: 16px;
            cursor: pointer;
            margin-top: 8px;
        }

        #startButton:hover {
            filter: brightness(1.1);
        }

        #languageSelector {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 200;
        }

        #languageSelector select {
            padding: 5px 8px;
            border-radius: 9999px;
            border: 1px solid #4b5563;
            background: rgba(15, 23, 42, 0.95);
            color: #e5e7eb;
            font-size: 12px;
        }

        #voiceToggle {
            position: absolute;
            top: 10px;
            left: 140px;
            z-index: 200;
            cursor: pointer;
            background: rgba(15, 23, 42, 0.95);
            padding: 5px 8px;
            border-radius: 9999px;
            border: 1px solid #4b5563;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        #voiceToggle span {
            font-size: 16px;
        }

        .stat-line {
            font-size: 13px;
            margin: 2px 0;
        }

        .stat-label {
            color: #9ca3af;
        }

        .stat-value {
            color: #e5e7eb;
            font-weight: bold;
        }

        #roomSelector {
            margin-top: 8px;
            font-size: 12px;
        }

        #roomSelect {
            padding: 4px 6px;
            border-radius: 9999px;
            border: 1px solid #4b5563;
            background: #020617;
            color: #e5e7eb;
        }

        #helpButton {
            margin-left: 8px;
            padding: 3px 8px;
            border-radius: 9999px;
            border: 1px solid #4b5563;
            background: rgba(15, 23, 42, 0.95);
            color: #e5e7eb;
            font-size: 12px;
            cursor: pointer;
        }

        #quizButton {
            padding: 6px 10px;
            border-radius: 9999px;
            border: none;
            background: linear-gradient(90deg, #22c55e, #a3e635);
            color: #052e16;
            font-weight: bold;
            font-size: 12px;
            cursor: pointer;
            margin-left: 8px;
        }

        #quizButton:hover {
            filter: brightness(1.1);
        }

        .safe-zone-label {
            position: absolute;
            padding: 4px 8px;
            background: rgba(22, 163, 74, 0.9);
            color: white;
            border-radius: 9999px;
            font-size: 11px;
            pointer-events: none;
            white-space: nowrap;
        }

        #safeZoneTimer {
            font-size: 12px;
            color: #22c55e;
            margin-top: 4px;
        }

        #deathOverlay {
            position: absolute;
            inset: 0;
            display: none;
            align-items: center;
            justify-content: center;
            background: rgba(15, 23, 42, 0.9);
            z-index: 120;
            color: #f87171;
            font-size: 24px;
            flex-direction: column;
        }

        #deathOverlay button {
            margin-top: 15px;
            padding: 8px 16px;
            border-radius: 9999px;
            border: none;
            background: #f97316;
            color: #111827;
            font-weight: bold;
            cursor: pointer;
        }

        #deathOverlay button:hover {
            filter: brightness(1.1);
        }

        #messageLog::-webkit-scrollbar,
        #leaderboardList::-webkit-scrollbar {
            width: 6px;
        }

        #messageLog::-webkit-scrollbar-thumb,
        #leaderboardList::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 9999px;
        }

        #messageLog::-webkit-scrollbar-track,
        #leaderboardList::-webkit-scrollbar-track {
            background: transparent;
        }

        #playerCount {
            font-size: 12px;
            margin-top: 4px;
            color: #9ca3af;
        }

        .room-link {
            display: inline-block;
            margin-top: 4px;
            font-size: 11px;
            color: #93c5fd;
        }

        .start-bg-triangle {
            position: absolute;
            width: 400px;
            height: 400px;
            background: conic-gradient(
                from 180deg at 50% 50%,
                rgba(56, 189, 248, 0.15),
                rgba(129, 140, 248, 0.25),
                rgba(56, 189, 248, 0.15)
            );
            filter: blur(40px);
            opacity: 0.8;
            z-index: -1;
        }

        .start-bg-triangle.left {
            top: 10%;
            left: 10%;
        }

        .start-bg-triangle.right {
            bottom: 5%;
            right: 15%;
        }

        @media (max-width: 768px) {
            #leaderboard {
                display: none;
            }
            #messageLog {
                max-width: 260px;
            }
            #startScreen h1 {
                font-size: 24px;
            }
            #startScreen h2 {
                font-size: 16px;
            }
        }

        @keyframes popIn {
            0% { transform: translate(-50%, -50%) scale(0.8); opacity: 0; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }
    </style>
</head>
<body>
    <div id="languageSelector">
        <select id="languageSelect">
            <option value="en">English</option>
            <option value="es">Espa√±ol</option>
        </select>
    </div>

    <div id="voiceToggle">
        <span id="voiceIcon">üîä</span>
        <span id="voiceLabel">Voice: On</span>
    </div>

    <div id="gameContainer">
        <canvas id="gameCanvas"></canvas>

        <div id="uiContainer">
            <div id="topLeftPanel" class="ui-panel">
                <div class="stat-line"><span class="stat-label" data-i18n="player">Player</span>: <span id="playerNameDisplay" class="stat-value">-</span></div>
                <div class="stat-line"><span class="stat-label" data-i18n="mass">Mass</span>: <span id="massDisplay" class="stat-value">0</span></div>
                <div class="stat-line"><span class="stat-label" data-i18n="banked">Banked</span>: <span id="bankedDisplay" class="stat-value">0</span></div>
                <div class="stat-line"><span class="stat-label" data-i18n="room">Room</span>: <span id="roomDisplay" class="stat-value">A</span></div>
                <div id="safeZoneTimer"></div>
                <div id="playerCount"></div>
                <div id="roomSelector">
                    <label for="roomSelect" data-i18n="changeRoom">Change Room:</label>
                    <select id="roomSelect">
                        <option value="room-a">Room A</option>
                        <option value="room-b">Room B</option>
                        <option value="room-c">Room C</option>
                        <option value="room-d">Room D</option>
                    </select>
                    <button id="helpButton" data-i18n="help">Help</button>
                    <button id="quizButton">Quiz</button>
                </div>
            </div>

            <div id="topRightPanel" class="ui-panel">
                <div id="instructionsShort">
                    <div data-i18n="goalTitle" style="font-weight:bold;">Goal:</div>
                    <div data-i18n="goalText">Grow your cell by eating food &amp; smaller players. Use safe zones to bank your score with SPACE.</div>
                </div>
            </div>
        </div>

        <div id="bottomPanel">
            <div id="controlsPanel">
                <div style="font-size: 12px; line-height: 1.4;">
                    <span data-i18n="controlsHeader" style="font-weight:bold;">Controls:</span>
                    <span data-i18n="controlsText">
                        Move with mouse/trackpad or arrow keys/WASD. Press SPACE to bank half your mass (safe zones only).
                    </span>
                </div>
            </div>
            <div id="messageLog"></div>
        </div>

        <div id="leaderboard">
            <h3>üèÜ Leaderboard</h3>
            <div id="leaderboardList"></div>
        </div>

        <div id="minimapContainer">
            <canvas id="minimap" width="200" height="200"></canvas>
        </div>

        <div id="deathOverlay">
            <div id="deathMessage">You were eaten!</div>
            <button id="respawnButton">Respawn</button>
        </div>

        <div id="startScreen">
            <div class="start-bg-triangle left"></div>
            <div class="start-bg-triangle right"></div>
            <h1>Mesopotamia Cell Arena</h1>
            <h2>Grow, Survive, and Learn!</h2>
            <label for="nameInput">Your Name:</label>
            <input id="nameInput" placeholder="Type your name..." maxlength="16" />
            <label for="classRoomSelect">Class / Room:</label>
            <select id="classRoomSelect">
                <option value="room-a">Room A</option>
                <option value="room-b">Room B</option>
                <option value="room-c">Room C</option>
                <option value="room-d">Room D</option>
            </select>
            <button id="startButton">Start Playing</button>
            <div style="margin-top: 10px; font-size: 12px; color: #9ca3af;">
                Move with mouse/trackpad or arrow keys/WASD. Press <strong>SPACE</strong> in a green safe zone to bank points!
            </div>
        </div>
    </div>

    <!-- Firebase App (replace config with your own if needed) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script>
        // ===================================================================
        // TRANSLATIONS
        // ===================================================================
        const translations = {
            en: {
                player: "Player",
                mass: "Mass",
                banked: "Banked",
                room: "Room",
                changeRoom: "Change Room:",
                help: "Help",
                goalTitle: "Goal:",
                goalText: "Grow your cell by eating food & smaller players. Use safe zones to bank your score with SPACE.",
                controlsHeader: "Controls:",
                controlsText: "Move with mouse/trackpad or arrow keys/WASD. Press SPACE to bank half your mass (safe zones only).",
                split: "You banked half your mass!",
                death: "You were eaten!",
                respawn: "Respawn",
                safeZoneEnter: "You entered a safe zone! Press SPACE to bank half your mass.",
                safeZoneExit: "You left the safe zone.",
                instructions:
                    "Welcome! Move with your mouse/trackpad or arrow keys/WASD. Eat the small dots to grow. If you are bigger than another player, you can eat them. " +
                    "Green safe zones let you press SPACE to bank half your mass as permanent score. The quiz button triggers a Mesopotamia question that can gain or lose mass."
            },
            es: {
                player: "Jugador",
                mass: "Masa",
                banked: "Guardado",
                room: "Sala",
                changeRoom: "Cambiar sala:",
                help: "Ayuda",
                goalTitle: "Objetivo:",
                goalText: "Haz crecer tu c√©lula comiendo comida y jugadores m√°s peque√±os. Usa las zonas seguras para guardar tu puntuaci√≥n con ESPACIO.",
                controlsHeader: "Controles:",
                controlsText: "Mu√©vete con el rat√≥n/panel t√°ctil o las flechas/WASD. Presiona ESPACIO para guardar la mitad de tu masa (solo en zonas seguras).",
                split: "¬°Guardaste la mitad de tu masa!",
                death: "¬°Te comieron!",
                respawn: "Reaparecer",
                safeZoneEnter: "¬°Entraste en una zona segura! Pulsa ESPACIO para guardar la mitad de tu masa.",
                safeZoneExit: "Saliste de la zona segura.",
                instructions:
                    "¬°Bienvenido! Mu√©vete con el rat√≥n/panel t√°ctil o las flechas/WASD. Come los puntos peque√±os para crecer. Si eres m√°s grande que otro jugador, puedes com√©rtelo. " +
                    "Las zonas seguras verdes te permiten presionar ESPACIO para guardar la mitad de tu masa como puntuaci√≥n permanente. El bot√≥n de examen lanza una pregunta de Mesopotamia que puede darte o quitarte masa."
            }
        };

        let currentLanguage = 'en';
        let voiceEnabled = true;

        function getTranslation(key) {
            const langPack = translations[currentLanguage] || translations.en;
            return langPack[key] || translations.en[key] || key;
        }

        function applyTranslations() {
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                el.textContent = getTranslation(key);
            });
        }

        // ===================================================================
        // TEXT-TO-SPEECH
        // ===================================================================
        function speakText(text, interrupt = false) {
            if (!('speechSynthesis' in window)) return;
            if (!voiceEnabled) return;
            const synth = window.speechSynthesis;
            if (interrupt) {
                synth.cancel();
            }
            const utter = new SpeechSynthesisUtterance(text);
            utter.lang = currentLanguage === 'es' ? 'es-ES' : 'en-US';
            synth.speak(utter);
        }

        // ===================================================================
        // FIREBASE INITIALIZATION
        // ===================================================================
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY_HERE",
            authDomain: "your-project.firebaseapp.com",
            databaseURL: "https://your-project-default-rtdb.firebaseio.com",
            projectId: "your-project",
            storageBucket: "your-project.appspot.com",
            messagingSenderId: "000000000000",
            appId: "1:000000000000:web:0000000000000000"
        };

        let firebaseEnabled = false;
        let database = null;
        let mesoDb = null;

        try {
            firebase.initializeApp(firebaseConfig);
            database = firebase.database();
            mesoDb = firebase.firestore();
            firebaseEnabled = true;
            console.log("Firebase initialized");
        } catch (err) {
            console.warn("Firebase initialization failed. Running in local-only mode.", err);
        }

        // ===================================================================
        // CANVAS & GLOBALS
        // ===================================================================
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const minimapCanvas = document.getElementById('minimap');
        const minimapCtx = minimapCanvas.getContext('2d');

        let gameStarted = false;
        let playerId = null;
        let playerName = '';
        let currentRoom = 'room-a';
        let player = null;
        let otherPlayers = {};
        let food = [];
        let camera = { x: 0, y: 0 };
        let mouse = { x: 0, y: 0 };
        let keys = {
            ArrowUp: false,
            ArrowDown: false,
            ArrowLeft: false,
            ArrowRight: false,
            KeyW: false,
            KeyA: false,
            KeyS: false,
            KeyD: false
        };
        const MOVE_KEYS = ['ArrowUp','ArrowDown','ArrowLeft','ArrowRight','KeyW','KeyA','KeyS','KeyD'];

        let lastUpdate = Date.now();
        let lastMass = 0;
        let inSafeZone = false;
        let safeZoneEnterTime = 0;
        let currentSafeZone = null;

        const safeZoneLabels = [];

        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        // ===================================================================
        // GAME CONFIGURATION
        // ===================================================================
        const CONFIG = {
            WORLD_WIDTH: 3000,
            WORLD_HEIGHT: 3000,
            INITIAL_MASS: 10,
            MAX_MASS: 300,
            FOOD_MASS: 1,
            MAX_FOOD: 300,
            FOOD_SIZE: 5,
            MIN_SPLIT_MASS: 20,
            SPLIT_SPEED: 15,
            SPEED_MULTIPLIER: 10,
            MASS_LOSS_RATE: 0.002,
            MIN_MASS: 10,
            SAFE_ZONE_SIZE: 400,
            SAFE_ZONE_TIME: 15000
        };

        function clampMass(mass) {
            return Math.max(CONFIG.MIN_MASS, Math.min(CONFIG.MAX_MASS, mass));
        }

        const SAFE_ZONES = [
            { x: 200, y: 200, label: 'Top Left' },
            { x: CONFIG.WORLD_WIDTH - 200, y: 200, label: 'Top Right' },
            { x: 200, y: CONFIG.WORLD_HEIGHT - 200, label: 'Bottom Left' },
            { x: CONFIG.WORLD_WIDTH - 200, y: CONFIG.WORLD_HEIGHT - 200, label: 'Bottom Right' }
        ];

        // ===================================================================
        // UTILS
        // ===================================================================
        function randColor() {
            const colors = ['#22c55e', '#3b82f6', '#f59e0b', '#ec4899', '#8b5cf6', '#14b8a6'];
            return colors[Math.floor(Math.random() * colors.length)];
        }

        function getRandomPosition() {
            return {
                x: Math.random() * CONFIG.WORLD_WIDTH,
                y: Math.random() * CONFIG.WORLD_HEIGHT
            };
        }

        function addMessage(text) {
            const log = document.getElementById('messageLog');
            const div = document.createElement('div');
            div.textContent = text;
            log.appendChild(div);
            log.scrollTop = log.scrollHeight;
        }

        // ===================================================================
        // CELL CLASS
        // ===================================================================
        class Cell {
            constructor(x, y, mass, color, name = '') {
                this.x = x;
                this.y = y;
                this.mass = mass;
                this.color = color;
                this.name = name;
                this.vx = 0;
                this.vy = 0;
                this.bankedScore = 0;
            }

            get radius() {
                return Math.sqrt(this.mass) * 4.5;
            }

            get speed() {
                return CONFIG.SPEED_MULTIPLIER / Math.sqrt(this.mass);
            }

            move(targetX, targetY) {
                const dx = targetX - this.x;
                const dy = targetY - this.y;
                const dist = Math.sqrt(dx * dx + dy * dy);

                if (dist > 10) {
                    this.vx = (dx / dist) * this.speed;
                    this.vy = (dy / dist) * this.speed;

                    this.x += this.vx;
                    this.y += this.vy;

                    this.x = Math.max(this.radius, Math.min(CONFIG.WORLD_WIDTH - this.radius, this.x));
                    this.y = Math.max(this.radius, Math.min(CONFIG.WORLD_HEIGHT - this.radius, this.y));
                }

                this.mass = clampMass(this.mass);

                if (this.mass > CONFIG.MIN_MASS) {
                    this.mass -= CONFIG.MASS_LOSS_RATE;
                    this.mass = clampMass(this.mass);
                }
            }

            draw(ctx, camX, camY) {
                const screenX = this.x - camX;
                const screenY = this.y - camY;

                if (this.inSafeZone) {
                    const pulse = Math.sin(Date.now() / 300) * 0.2 + 0.8;
                    ctx.strokeStyle = 'rgba(0, 255, 100, ' + pulse + ')';
                    ctx.lineWidth = 5;
                    ctx.beginPath();
                    ctx.arc(screenX, screenY, this.radius + 8, 0, Math.PI * 2);
                    ctx.stroke();
                }

                ctx.fillStyle = this.color;
                ctx.beginPath();
                ctx.arc(screenX, screenY, this.radius, 0, Math.PI * 2);
                ctx.fill();

                ctx.strokeStyle = "#0f172a";
                ctx.lineWidth = 2;
                ctx.stroke();

                ctx.fillStyle = "#e5e7eb";
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';

                if (this.name) {
                    ctx.font = 'bold 16px Arial';
                    ctx.fillText(this.name, screenX, screenY - 5);
                    ctx.font = '14px Arial';
                    ctx.fillText(Math.floor(this.mass), screenX, screenY + 15);
                }
            }

            canEat(otherCell) {
                return this.mass > otherCell.mass * 1.2;
            }

            eat(otherCell) {
                this.mass = clampMass(this.mass + otherCell.mass);
            }

            split() {
                if (this.mass < CONFIG.MIN_SPLIT_MASS) return null;

                const bankAmount = Math.floor(this.mass / 2);
                this.mass -= bankAmount;
                this.bankedScore += bankAmount;

                const notification = document.createElement('div');
                notification.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: rgba(255, 215, 0, 0.95);
                    color: #000;
                    padding: 30px 50px;
                    border-radius: 20px;
                    font-size: 2em;
                    font-weight: bold;
                    z-index: 10000;
                    animation: popIn 0.5s;
                `;
                notification.textContent = `+${bankAmount} BANKED! üí∞`;
                document.body.appendChild(notification);

                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 1500);

                this.mass = clampMass(this.mass);
                return null;
            }
        }

        // ===================================================================
        // FOOD & FIREBASE
        // ===================================================================
        function generateFood() {
            while (food.length < CONFIG.MAX_FOOD) {
                const pos = getRandomPosition();
                food.push({
                    id: 'food_' + Date.now() + '_' + Math.random(),
                    x: pos.x,
                    y: pos.y,
                    mass: CONFIG.FOOD_MASS,
                    radius: CONFIG.FOOD_SIZE,
                    color: '#facc15'
                });
            }
        }

        function drawFood() {
            food.forEach(f => {
                const screenX = f.x - camera.x;
                const screenY = f.y - camera.y;
                if (screenX > -50 && screenX < canvas.width + 50 &&
                    screenY > -50 && screenY < canvas.height + 50) {
                    ctx.fillStyle = f.color;
                    ctx.beginPath();
                    ctx.arc(screenX, screenY, f.radius, 0, Math.PI * 2);
                    ctx.fill();
                }
            });
        }

        function syncPlayerToFirebase() {
            if (!firebaseEnabled || !player) return;

            database.ref('rooms/' + currentRoom + '/players/' + playerId).set({
                id: playerId,
                name: player.name,
                x: player.x,
                y: player.y,
                mass: clampMass(player.mass),
                bankedScore: player.bankedScore,
                color: player.color,
                inSafeZone: inSafeZone,
                lastUpdate: Date.now()
            });
        }

        function listenToOtherPlayers() {
            if (!firebaseEnabled) return;
            database.ref('rooms/' + currentRoom + '/players').on('value', (snapshot) => {
                const players = snapshot.val();
                otherPlayers = {};
                if (players) {
                    Object.keys(players).forEach(id => {
                        if (id !== playerId) {
                            const p = players[id];
                            if (Date.now() - p.lastUpdate < 10000) {
                                const safeMass = clampMass(p.mass || CONFIG.INITIAL_MASS);
                                const cell = new Cell(p.x, p.y, safeMass, p.color, p.name);
                                cell.bankedScore = p.bankedScore || 0;
                                cell.inSafeZone = p.inSafeZone || false;
                                otherPlayers[id] = cell;
                            }
                        }
                    });
                }
                updatePlayerCount();
            });
        }

        function removePlayerFromFirebase() {
            if (!firebaseEnabled || !playerId) return;
            database.ref('rooms/' + currentRoom + '/players/' + playerId).remove();
        }

        function listenForDeaths() {
            if (!firebaseEnabled) return;
            database.ref('rooms/' + currentRoom + '/deaths/' + playerId).on('value', (snapshot) => {
                const deathData = snapshot.val();
                if (deathData && gameStarted) {
                    speakText(`Oh no! ${deathData.killerName} ate you!`);
                    respawnPlayer();
                }
            });
        }

        function logDeath(victimId, killerName) {
            if (!firebaseEnabled) return;
            database.ref('rooms/' + currentRoom + '/deaths/' + victimId).set({
                killerName,
                time: Date.now()
            });
        }

        // ===================================================================
        // SAFE ZONES
        // ===================================================================
        function drawSafeZones() {
            SAFE_ZONES.forEach((zone, index) => {
                const screenX = zone.x - camera.x;
                const screenY = zone.y - camera.y;
                const radius = CONFIG.SAFE_ZONE_SIZE;

                const gradient = ctx.createRadialGradient(
                    screenX, screenY, radius * 0.1,
                    screenX, screenY, radius
                );
                gradient.addColorStop(0, 'rgba(34, 197, 94, 0.25)');
                gradient.addColorStop(1, 'rgba(22, 163, 74, 0.02)');

                ctx.fillStyle = gradient;
                ctx.beginPath();
                ctx.arc(screenX, screenY, radius, 0, Math.PI * 2);
                ctx.fill();

                ctx.strokeStyle = 'rgba(34, 197, 94, 0.7)';
                ctx.lineWidth = 2;
                ctx.setLineDash([10, 10]);
                ctx.beginPath();
                ctx.arc(screenX, screenY, radius, 0, Math.PI * 2);
                ctx.stroke();
                ctx.setLineDash([]);

                const labelEl = safeZoneLabels[index];
                if (labelEl) {
                    const rect = canvas.getBoundingClientRect();
                    labelEl.style.left = (screenX + rect.left) + 'px';
                    labelEl.style.top = (screenY + rect.top - radius - 20) + 'px';
                }
            });
        }

        function isInSafeZone(x, y) {
            for (let i = 0; i < SAFE_ZONES.length; i++) {
                const zone = SAFE_ZONES[i];
                const dx = x - zone.x;
                const dy = y - zone.y;
                const dist = Math.sqrt(dx * dx + dy * dy);
                if (dist <= CONFIG.SAFE_ZONE_SIZE) {
                    return zone;
                }
            }
            return null;
        }

        function updateSafeZoneLabels() {
            const containerRect = canvas.getBoundingClientRect();
            SAFE_ZONES.forEach((zone, index) => {
                const labelEl = safeZoneLabels[index];
                if (!labelEl) return;
                const screenX = zone.x - camera.x;
                const screenY = zone.y - camera.y;
                labelEl.style.left = (screenX + containerRect.left - 30) + 'px';
                labelEl.style.top = (screenY + containerRect.top - CONFIG.SAFE_ZONE_SIZE - 30) + 'px';
            });
        }

        function checkSafeZoneStatus() {
            const zone = isInSafeZone(player.x, player.y);
            const safeTimerEl = document.getElementById('safeZoneTimer');

            if (zone && !inSafeZone) {
                inSafeZone = true;
                safeZoneEnterTime = Date.now();
                currentSafeZone = zone;
                addMessage(getTranslation('safeZoneEnter'));
                speakText(getTranslation('safeZoneEnter'));
            } else if (!zone && inSafeZone) {
                inSafeZone = false;
                currentSafeZone = null;
                safeTimerEl.textContent = '';
                addMessage(getTranslation('safeZoneExit'));
                speakText(getTranslation('safeZoneExit'));
            }

            if (inSafeZone && safeZoneEnterTime) {
                const elapsed = Date.now() - safeZoneEnterTime;
                const remaining = Math.max(0, CONFIG.SAFE_ZONE_TIME - elapsed);
                const seconds = Math.ceil(remaining / 1000);
                safeTimerEl.textContent = `Safe Zone Time: ${seconds}s`;
                if (remaining <= 0) {
                    inSafeZone = false;
                    currentSafeZone = null;
                    safeTimerEl.textContent = '';
                    addMessage("Time's up! You left the safe zone.");
                    speakText("Time's up! Ejected from safe zone!");
                }
            }
        }

        // ===================================================================
        // WORLD RENDERING
        // ===================================================================
        function drawGrid() {
            const gridSize = 100;
            ctx.strokeStyle = 'rgba(148, 163, 184, 0.2)';
            ctx.lineWidth = 0.5;

            const startX = -camera.x % gridSize;
            const startY = -camera.y % gridSize;

            for (let x = startX; x < canvas.width; x += gridSize) {
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, canvas.height);
                ctx.stroke();
            }
            for (let y = startY; y < canvas.height; y += gridSize) {
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(canvas.width, y);
                ctx.stroke();
            }
        }

        function drawWorldBorder() {
            const left = -camera.x;
            const top = -camera.y;
            const right = CONFIG.WORLD_WIDTH - camera.x;
            const bottom = CONFIG.WORLD_HEIGHT - camera.y;

            ctx.strokeStyle = '#38bdf8';
            ctx.lineWidth = 4;
            ctx.strokeRect(left, top, right - left, bottom - top);
        }

        function updateCamera() {
            camera.x = player.x - canvas.width / 2;
            camera.y = player.y - canvas.height / 2;
            camera.x = Math.max(0, Math.min(CONFIG.WORLD_WIDTH - canvas.width, camera.x));
            camera.y = Math.max(0, Math.min(CONFIG.WORLD_HEIGHT - canvas.height, camera.y));
        }

        function updateStats() {
            document.getElementById('massDisplay').textContent = Math.floor(player.mass);
            document.getElementById('bankedDisplay').textContent = player.bankedScore;
            document.getElementById('playerNameDisplay').textContent = player.name;
            document.getElementById('roomDisplay').textContent = currentRoom.split('-')[1].toUpperCase();
        }

        function updateLeaderboard() {
            const allPlayers = [
                {
                    id: playerId,
                    name: player.name || 'You',
                    mass: player.mass,
                    bankedScore: player.bankedScore,
                    isSelf: true
                },
                ...Object.keys(otherPlayers).map(id => {
                    const op = otherPlayers[id];
                    return {
                        id,
                        name: op.name || 'Player',
                        mass: op.mass,
                        bankedScore: op.bankedScore || 0,
                        isSelf: false
                    };
                })
            ];

            // Sort ONLY by banked score
            allPlayers.sort((a, b) => b.bankedScore - a.bankedScore);

            const leaderboardHtml = allPlayers.slice(0, 10).map((p, index) => {
                const medal = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : (index + 1) + '.';
                const selfHighlight = p.isSelf ? 'style="color:#facc15;font-weight:bold;"' : '';
                return `
                <div class="leaderboard-entry">
                    <span class="name" ${selfHighlight}>${medal} ${p.name}</span>
                    <span class="stats">
                        <span style="color:#34d399;">${Math.floor(p.mass)}</span>
                        <span style="color:#facc15;">üí∞${p.bankedScore}</span>
                    </span>
                </div>`;
            }).join('');

            document.getElementById('leaderboardList').innerHTML = leaderboardHtml;
        }

        function updatePlayerCount() {
            const count = Object.keys(otherPlayers).length + 1;
            document.getElementById('playerCount').textContent = `Players in room: ${count}`;
        }

        function drawMinimap() {
            minimapCtx.clearRect(0, 0, minimapCanvas.width, minimapCanvas.height);

            minimapCtx.strokeStyle = '#38bdf8';
            minimapCtx.lineWidth = 2;
            minimapCtx.strokeRect(0, 0, minimapCanvas.width, minimapCanvas.height);

            const scaleX = minimapCanvas.width / CONFIG.WORLD_WIDTH;
            const scaleY = minimapCanvas.height / CONFIG.WORLD_HEIGHT;

            SAFE_ZONES.forEach(zone => {
                const x = zone.x * scaleX;
                const y = zone.y * scaleY;
                const r = CONFIG.SAFE_ZONE_SIZE * scaleX;
                minimapCtx.fillStyle = 'rgba(34,197,94,0.4)';
                minimapCtx.beginPath();
                minimapCtx.arc(x, y, r, 0, Math.PI * 2);
                minimapCtx.fill();
                minimapCtx.strokeStyle = 'rgba(34,197,94,0.8)';
                minimapCtx.lineWidth = 1;
                minimapCtx.beginPath();
                minimapCtx.arc(x, y, r, 0, Math.PI * 2);
                minimapCtx.stroke();
            });

            food.forEach(f => {
                const x = f.x * scaleX;
                const y = f.y * scaleY;
                minimapCtx.fillStyle = '#facc15';
                minimapCtx.fillRect(x - 1, y - 1, 2, 2);
            });

            Object.values(otherPlayers).forEach(p => {
                const x = p.x * scaleX;
                const y = p.y * scaleY;
                minimapCtx.fillStyle = p.inSafeZone ? '#22c55e' : '#3b82f6';
                minimapCtx.beginPath();
                minimapCtx.arc(x, y, 4, 0, Math.PI * 2);
                minimapCtx.fill();
            });

            const px = player.x * scaleX;
            const py = player.y * scaleY;
            minimapCtx.fillStyle = '#f97316';
            minimapCtx.beginPath();
            minimapCtx.arc(px, py, 5, 0, Math.PI * 2);
            minimapCtx.fill();
        }

        // ===================================================================
        // COLLISIONS
        // ===================================================================
        function checkCollisions() {
            // Player with food
            for (let i = food.length - 1; i >= 0; i--) {
                const f = food[i];
                const dx = player.x - f.x;
                const dy = player.y - f.y;
                const dist = Math.sqrt(dx * dx + dy * dy);
                if (dist < player.radius + f.radius) {
                    player.mass = clampMass(player.mass + f.mass);
                    food.splice(i, 1);
                }
            }
            generateFood();

            // Player with other players
            Object.keys(otherPlayers).forEach(id => {
                const op = otherPlayers[id];
                const dx = player.x - op.x;
                const dy = player.y - op.y;
                const dist = Math.sqrt(dx * dx + dy * dy);
                if (dist < player.radius + op.radius) {
                    if (player.canEat(op)) {
                        player.eat(op);
                        if (firebaseEnabled) {
                            logDeath(id, player.name || 'You');
                            database.ref('rooms/' + currentRoom + '/players/' + id).remove();
                        }
                        delete otherPlayers[id];
                        addMessage(`You ate ${op.name || 'a player'}!`);
                        speakText(`You ate ${op.name || 'a player'}!`);
                    } else if (op.canEat(player)) {
                        if (firebaseEnabled) {
                            logDeath(playerId, op.name || 'A player');
                        }
                        showDeathScreen(op.name || 'another player');
                    }
                }
            });
        }

        function showDeathScreen(killerName) {
            gameStarted = false;
            document.getElementById('deathMessage').textContent =
                `${getTranslation('death')} (${killerName})`;
            document.getElementById('deathOverlay').style.display = 'flex';
            speakText(`${getTranslation('death')} by ${killerName}`);
        }

        function respawnPlayer() {
            const startPos = getRandomSafeZonePosition();
            player.x = startPos.x;
            player.y = startPos.y;
            player.mass = clampMass(CONFIG.INITIAL_MASS);
            lastMass = player.mass;

            inSafeZone = false;
            safeZoneEnterTime = 0;
            currentSafeZone = null;
            document.getElementById('safeZoneTimer').textContent = '';

            document.getElementById('deathOverlay').style.display = 'none';
            gameStarted = true;
        }

        function getRandomSafeZonePosition() {
            const zoneIndex = Math.floor(Math.random() * SAFE_ZONES.length);
            const zone = SAFE_ZONES[zoneIndex];
            const angle = Math.random() * Math.PI * 2;
            const distance = Math.random() * 50;
            return {
                x: zone.x + Math.cos(angle) * distance,
                y: zone.y + Math.sin(angle) * distance
            };
        }

        // ===================================================================
        // QUIZ SYSTEM
        // ===================================================================
        const mesoQuestions = [
            {
                text: "Which two rivers surrounded Mesopotamia?",
                choices: {
                    A: "Nile and Congo",
                    B: "Tigris and Euphrates",
                    C: "Amazon and Mississippi",
                    D: "Yellow and Yangtze"
                },
                correct: "B",
                difficulty: 1
            },
            {
                text: "Which empire built a famous library at Nineveh?",
                choices: {
                    A: "Sumerian",
                    B: "Akkadian",
                    C: "Assyrian",
                    D: "Persian"
                },
                correct: "C",
                difficulty: 2
            },
            {
                text: "Who built the Royal Road and used satraps to rule the empire?",
                choices: {
                    A: "Hammurabi",
                    B: "Nebuchadnezzar II",
                    C: "Ashurbanipal",
                    D: "Darius I"
                },
                correct: "D",
                difficulty: 2
            },
            {
                text: "What was the name of the first written law code in Mesopotamia?",
                choices: {
                    A: "The Ten Commandments",
                    B: "Code of Hammurabi",
                    C: "Twelve Tables",
                    D: "Magna Carta"
                },
                correct: "B",
                difficulty: 1
            },
            {
                text: "Which empire is known for its policy of tolerating conquered peoples' religions?",
                choices: {
                    A: "Assyrian Empire",
                    B: "Persian Empire",
                    C: "Babylonian Empire",
                    D: "Hittite Empire"
                },
                correct: "B",
                difficulty: 3
            }
        ];

        let mesoCurrentQuestion = null;
        let mesoOverlayVisible = false;

        function mesoPickQuestion() {
            return mesoQuestions[Math.floor(Math.random() * mesoQuestions.length)];
        }

        function mesoLogAnswer(question, chosen, isCorrect) {
            if (!mesoDb) return;
            const record = {
                playerId,
                playerName,
                room: currentRoom,
                questionText: question.text,
                correctAnswer: question.correct,
                chosenAnswer: chosen,
                difficulty: question.difficulty,
                wasCorrect: isCorrect,
                deltaMass: isCorrect ? +10 : -10,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            mesoDb.collection("mesopotamia_scores").add(record).catch(err => {
                console.error("Error logging quiz answer:", err);
            });
        }

        function mesoShowQuestion() {
            if (mesoOverlayVisible || !gameStarted || !player) return;

            const wasPlaying = gameStarted;
            gameStarted = false;

            const q = mesoPickQuestion();
            mesoCurrentQuestion = q;

            const overlay = document.createElement("div");
            overlay.id = "mesoQuizOverlay";
            Object.assign(overlay.style, {
                position: "fixed",
                inset: "0",
                background: "rgba(15, 23, 42, 0.92)",
                display: "flex",
                justifyContent: "center",
                alignItems: "center",
                fontFamily: "Arial, sans-serif",
                zIndex: "2000"
            });

            const card = document.createElement("div");
            Object.assign(card.style, {
                background: "linear-gradient(135deg, #1e3a8a 0%, #312e81 100%)",
                borderRadius: "20px",
                padding: "30px",
                maxWidth: "600px",
                width: "90%",
                color: "#ffffff",
                boxShadow: "0 10px 40px rgba(0,0,0,0.6)",
                border: "2px solid #60a5fa"
            });

            const title = document.createElement("h2");
            title.textContent = "üìú Mesopotamia Knowledge Check";
            title.style.marginBottom = "10px";
            title.style.textAlign = "center";
            title.style.fontSize = "24px";

            const subtitle = document.createElement("div");
            subtitle.textContent = "Topic 2 Lesson 3: Assyrian & Persian Empires";
            subtitle.style.fontSize = "14px";
            subtitle.style.color = "#93c5fd";
            subtitle.style.textAlign = "center";
            subtitle.style.marginBottom = "20px";

            const questionEl = document.createElement("div");
            questionEl.textContent = q.text;
            questionEl.style.fontSize = "18px";
            questionEl.style.margin = "20px 0";
            questionEl.style.fontWeight = "500";
            questionEl.style.lineHeight = "1.5";

            const choicesEl = document.createElement("div");
            choicesEl.style.marginTop = "20px";

            const feedbackEl = document.createElement("div");
            feedbackEl.style.marginTop = "15px";
            feedbackEl.style.fontSize = "16px";
            feedbackEl.style.textAlign = "center";
            feedbackEl.style.fontWeight = "bold";

            ["A", "B", "C", "D"].forEach(label => {
                const btn = document.createElement("button");
                btn.textContent = label + ". " + q.choices[label];
                Object.assign(btn.style, {
                    display: "block",
                    width: "100%",
                    margin: "10px 0",
                    padding: "15px",
                    fontSize: "16px",
                    cursor: "pointer",
                    borderRadius: "12px",
                    border: "2px solid #60a5fa",
                    background: "#1e40af",
                    color: "#ffffff",
                    textAlign: "left",
                    transition: "all 0.2s",
                    fontWeight: "500"
                });

                btn.onmouseover = () => {
                    btn.style.background = "#2563eb";
                    btn.style.transform = "scale(1.02)";
                };
                btn.onmouseout = () => {
                    btn.style.background = "#1e40af";
                    btn.style.transform = "scale(1)";
                };

                btn.onclick = () => {
                    const isCorrect = (label === q.correct);

                    if (isCorrect) {
                        player.mass = clampMass(player.mass + 10);
                        feedbackEl.textContent = "‚úÖ Correct! +10 Mass";
                        feedbackEl.style.color = "#22c55e";
                        speakText("Correct! You gained 10 mass!");
                    } else {
                        player.mass = clampMass(player.mass - 10);
                        feedbackEl.textContent = `‚ùå Incorrect! -10 Mass. Answer: ${q.correct}. ${q.choices[q.correct]}`;
                        feedbackEl.style.color = "#f87171";
                        speakText("Incorrect. You lost 10 mass.");
                    }

                    mesoLogAnswer(q, label, isCorrect);

                    const allButtons = choicesEl.querySelectorAll("button");
                    allButtons.forEach(b => {
                        b.disabled = true;
                        b.style.opacity = "0.5";
                    });

                    setTimeout(() => {
                        document.body.removeChild(overlay);
                        mesoOverlayVisible = false;
                        if (wasPlaying) {
                            gameStarted = true;
                        }
                    }, 1500);
                };

                choicesEl.appendChild(btn);
            });

            const closeBtn = document.createElement("button");
            closeBtn.textContent = "Skip";
            Object.assign(closeBtn.style, {
                marginTop: "10px",
                padding: "8px 16px",
                borderRadius: "9999px",
                border: "none",
                background: "#f97316",
                color: "#111827",
                fontWeight: "bold",
                cursor: "pointer",
                display: "block",
                marginLeft: "auto",
                marginRight: "auto"
            });
            closeBtn.onclick = () => {
                document.body.removeChild(overlay);
                mesoOverlayVisible = false;
                if (wasPlaying) {
                    gameStarted = true;
                }
            };

            card.appendChild(title);
            card.appendChild(subtitle);
            card.appendChild(questionEl);
            card.appendChild(choicesEl);
            card.appendChild(feedbackEl);
            card.appendChild(closeBtn);

            overlay.appendChild(card);
            document.body.appendChild(overlay);
            mesoOverlayVisible = true;
        }

        // ===================================================================
        // MAIN GAME LOOP
        // ===================================================================
        function gameLoop() {
            if (!gameStarted) return;
            const now = Date.now();
            const dt = (now - lastUpdate) / 1000;
            lastUpdate = now;

            ctx.fillStyle = 'rgba(102, 126, 234, 0.1)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            drawGrid();
            drawWorldBorder();
            drawSafeZones();

            let targetX = mouse.x + camera.x;
            let targetY = mouse.y + camera.y;

            const up = keys.ArrowUp || keys.KeyW;
            const down = keys.ArrowDown || keys.KeyS;
            const left = keys.ArrowLeft || keys.KeyA;
            const right = keys.ArrowRight || keys.KeyD;

            if (up || down || left || right) {
                let dx = 0, dy = 0;
                if (up) dy -= 1;
                if (down) dy += 1;
                if (left) dx -= 1;
                if (right) dx += 1;

                const len = Math.hypot(dx, dy);
                if (len > 0) {
                    dx /= len;
                    dy /= len;
                    targetX = player.x + dx * 1000;
                    targetY = player.y + dy * 1000;
                }
            }

            player.move(targetX, targetY);
            checkSafeZoneStatus();
            checkCollisions();
            updateCamera();
            drawFood();
            Object.values(otherPlayers).forEach(p => p.draw(ctx, camera.x, camera.y));
            player.draw(ctx, camera.x, camera.y);
            updateStats();
            updateLeaderboard();
            drawMinimap();

            if (now % 100 < 16) {
                syncPlayerToFirebase();
            }
            requestAnimationFrame(gameLoop);
        }

        // ===================================================================
        // INPUT HANDLERS
        // ===================================================================
        canvas.addEventListener('mousemove', (e) => {
            const rect = canvas.getBoundingClientRect();
            mouse.x = e.clientX - rect.left;
            mouse.y = e.clientY - rect.top;
        });

        canvas.addEventListener('touchstart', (e) => {
            e.preventDefault();
            const rect = canvas.getBoundingClientRect();
            const touch = e.touches[0];
            mouse.x = touch.clientX - rect.left;
            mouse.y = touch.clientY - rect.top;
        }, { passive: false });

        canvas.addEventListener('touchmove', (e) => {
            e.preventDefault();
            const rect = canvas.getBoundingClientRect();
            const touch = e.touches[0];
            mouse.x = touch.clientX - rect.left;
            mouse.y = touch.clientY - rect.top;
        }, { passive: false });

        document.addEventListener('keydown', (e) => {
            if (!gameStarted) return;

            if (e.code === 'Space') {
                e.preventDefault();
                const newCell = player.split();
                if (newCell) {
                    speakText(getTranslation('split'));
                }
            }

            if (MOVE_KEYS.includes(e.code)) {
                e.preventDefault();
                keys[e.code] = true;
            }
        });

        document.addEventListener('keyup', (e) => {
            if (!gameStarted) return;
            if (MOVE_KEYS.includes(e.code)) {
                e.preventDefault();
                keys[e.code] = false;
            }
        });

        document.getElementById('startButton').addEventListener('click', startGame);
        document.getElementById('respawnButton').addEventListener('click', () => {
            respawnPlayer();
        });

        document.getElementById('roomSelect').addEventListener('change', (e) => {
            const newRoom = e.target.value;
            changeRoom(newRoom);
        });

        document.getElementById('classRoomSelect').addEventListener('change', (e) => {
            currentRoom = e.target.value;
        });

        document.getElementById('helpButton').addEventListener('click', () => {
            const helpText = getTranslation('instructions');
            addMessage(helpText);
            speakText(helpText, true);
        });

        document.getElementById('quizButton').addEventListener('click', () => {
            mesoShowQuestion();
        });

        document.getElementById('languageSelect').addEventListener('change', (e) => {
            currentLanguage = e.target.value;
            applyTranslations();
            const label = document.getElementById('voiceLabel');
            label.textContent = voiceEnabled ? 'Voice: On' : 'Voice: Off';
        });

        document.getElementById('voiceToggle').addEventListener('click', () => {
            voiceEnabled = !voiceEnabled;
            const label = document.getElementById('voiceLabel');
            const icon = document.getElementById('voiceIcon');
            if (voiceEnabled) {
                label.textContent = 'Voice: On';
                icon.textContent = 'üîä';
            } else {
                label.textContent = 'Voice: Off';
                icon.textContent = 'üîá';
                if (window.speechSynthesis) {
                    window.speechSynthesis.cancel();
                }
            }
        });

        // ===================================================================
        // ROOM & STARTUP
        // ===================================================================
        function changeRoom(newRoom) {
            if (firebaseEnabled && playerId) {
                database.ref('rooms/' + currentRoom + '/players/' + playerId).remove();
            }
            currentRoom = newRoom;
            document.getElementById('roomDisplay').textContent = currentRoom.split('-')[1].toUpperCase();
            addMessage(`Switched to ${currentRoom.toUpperCase()}`);
            if (firebaseEnabled && playerId) {
                syncPlayerToFirebase();
                listenToOtherPlayers();
            }
        }

        function createSafeZoneLabels() {
            SAFE_ZONES.forEach((zone, index) => {
                const label = document.createElement('div');
                label.className = 'safe-zone-label';
                label.textContent = 'SAFE ZONE';
                document.body.appendChild(label);
                safeZoneLabels[index] = label;
            });
            updateSafeZoneLabels();
        }

        function startGame() {
            const nameInput = document.getElementById('nameInput').value.trim();
            playerName = nameInput || 'Player';
            document.getElementById('startScreen').style.display = 'none';

            const startPos = getRandomSafeZonePosition();
            playerId = 'player_' + Math.random().toString(36).substr(2, 9);
            player = new Cell(startPos.x, startPos.y, CONFIG.INITIAL_MASS, randColor(), playerName);
            lastMass = player.mass;

            generateFood();
            createSafeZoneLabels();
            updateSafeZoneLabels();

            document.getElementById('roomDisplay').textContent = currentRoom.split('-')[1].toUpperCase();
            document.getElementById('playerNameDisplay').textContent = playerName;

            applyTranslations();
            addMessage("Game started. Good luck!");
            speakText("Game started. Good luck!");

            gameStarted = true;

            if (firebaseEnabled) {
                listenToOtherPlayers();
                listenForDeaths();
                window.addEventListener('beforeunload', removePlayerFromFirebase);
            }

            lastUpdate = Date.now();
            requestAnimationFrame(gameLoop);
        }

        // ===================================================================
        // INIT
        // ===================================================================
        applyTranslations();
        createSafeZoneLabels();

        window.addEventListener('resize', () => {
            resizeCanvas();
            updateSafeZoneLabels();
        });
    </script>
</body>
</html>
